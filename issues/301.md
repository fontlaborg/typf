# Issue 301: Backend Recognition Failures in Python Bindings

**Date:** 2025-11-18
**Status:** Open
**Severity:** High
**Component:** Python bindings (`python/src/lib.rs`)

## Summary

When running `python toy.py render`, backends that should be available are not recognized, resulting in "Unknown backend" errors. This affects CoreText (on macOS), DirectWrite (on Windows), and Orge (cross-platform).

## Observed Behavior

```bash
$ python toy.py render
Rendering sample text with all available backends...

coretext        ‚úó Unknown backend: coretext
harfbuzz        ‚úì Saved render-harfbuzz.png
directwrite     ‚úó Unknown backend: directwrite
orge            ‚úó Unknown backend: orge
```

**Platform:** macOS (Darwin 25.1.0)
**Expected:** CoreText should work (platform-native backend)
**Actual:** Only HarfBuzz works

## Root Cause Analysis

### 1. CoreText Backend Not Available (Critical)

**Problem:** The `mac` feature is not being enabled during Python builds, despite being specified in `maturin develop` commands.

**Evidence:**
```bash
$ cd python && cargo rustc -- --print cfg | grep feature
feature="default"
```

Only `feature="default"` is shown. No `feature="mac"` or `feature="icu"` present.

**Root Cause:**
The `pyproject.toml` specifies default features that override command-line arguments:

```toml
[tool.maturin]
features = ["python", "icu"]  # Line 75
```

When running `maturin develop --features "python,icu,mac"`, the command-line features are **not being merged** with the pyproject.toml defaults. This is a known maturin behavior where `pyproject.toml` takes precedence.

**Impact:** Platform-specific backends are unavailable even when explicitly requested.

---

### 2. DirectWrite Error Message Unclear (Medium)

**Problem:** On macOS, requesting `backend="directwrite"` returns "Unknown backend: directwrite", which is technically correct but unhelpful.

**Current Code (python/src/lib.rs:254-284):**
```rust
let backend: Box<dyn Backend> = match backend_name {
    #[cfg(all(target_os = "windows", feature = "windows"))]
    "directwrite" => Box::new(DirectWriteBackend::new()?),

    // ... other backends ...

    _ => {
        return Err(PyValueError::new_err(format!(
            "Unknown backend: {backend_name}"
        )))
    }
};
```

**Issue:** If we're on macOS and the "directwrite" match arm doesn't exist (due to `#[cfg]`), it falls through to the generic "Unknown backend" error.

**Better Error Message:** "DirectWrite backend is only available on Windows (current platform: macOS)"

---

### 3. Orge Backend Incomplete (Critical)

**Problem 1 - Feature Not Enabled:**
Similar to CoreText, the `orge` feature is not included in the default `pyproject.toml` features.

**Problem 2 - Missing Trait Implementation:**
Even when the `orge` feature is enabled, compilation fails:

```bash
$ maturin develop --release --features "python,icu,mac,orge"
error[E0277]: the trait bound `OrgeBackend: Backend` is not satisfied
   --> python/src/lib.rs:268:23
    |
268 |             "orge" => Box::new(OrgeBackend::new()),
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |                       the trait `Backend` is not implemented for `OrgeBackend`
    |
    = help: the following other types implement trait `Backend`:
              CoreTextBackend
              HarfBuzzBackend
```

**Root Cause:**
`OrgeBackend` only implements `DynBackend` but not the full `Backend` trait (from `typf_core::traits::Backend`).

**Evidence (backends/typf-orge/src/lib.rs:222):**
```rust
impl DynBackend for OrgeBackend {
    fn name(&self) -> &'static str { "Orge" }
    fn shape_text(&self, _text: &str, _font: &Font) -> ShapingResult { ... }
    fn render_glyph(&self, font: &Font, glyph_id: u32, options: RenderOptions) -> Option<Bitmap> {
        // TODO: Implement proper glyph rendering using GlyphRasterizer
        None  // Currently returns None!
    }
    // ...
}
```

Missing implementation of `Backend` trait methods:
- `segment(&self, text: &str, options: &SegmentOptions) -> Result<Vec<TextRun>>`
- `shape(&self, run: &TextRun, font: &Font) -> Result<ShapingResult>`
- `render(&self, shaped: &ShapingResult, options: &RenderOptions) -> Result<RenderOutput>`

---

## Architectural Observations

### Dual Trait System

The codebase has two backend trait systems:

1. **`Backend` trait** (`typf_core::traits::Backend`)
   - Full-featured trait with `segment()`, `shape()`, `render()`
   - Required for Python bindings
   - Implemented by: CoreTextBackend, HarfBuzzBackend, DirectWriteBackend

2. **`DynBackend` trait** (`typf_core::backend_trait`)
   - Simpler trait with `name()`, `shape_text()`, `render_glyph()`
   - Used for backend discovery and metadata
   - Implemented by: All backends

**Issue:** OrgeBackend only implements `DynBackend`, making it incompatible with Python bindings that expect `Box<dyn Backend>`.

---

## Improvement Proposals

### Fix 1: CoreText Feature Enablement (High Priority)

**Option A - Update pyproject.toml (Recommended):**
```toml
[tool.maturin]
# Platform-conditional features
features = [
    "python",
    "icu",  # Cross-platform fallback
]

# Platform-specific extras (requires maturin 1.5+)
[tool.maturin.target.'cfg(target_os = "macos")']
features = ["mac"]

[tool.maturin.target.'cfg(target_os = "windows")']
features = ["windows"]

[tool.maturin.target.'cfg(target_os = "linux")']
features = ["icu"]
```

**Option B - Documentation Fix:**
Update build instructions to use feature override syntax:
```bash
# Don't use this (overridden by pyproject.toml):
maturin develop --features "python,icu,mac"

# Use this instead (forces features):
cd python
cargo build --release --features "python,icu,mac"
cp target/release/libtypf.so ../.venv/lib/python3.12/site-packages/typf.so
```

**Option C - Remove pyproject.toml features:**
Remove line 75 from `pyproject.toml` and always require explicit `--features` flag.

---

### Fix 2: Better Error Messages (Medium Priority)

**Implementation:**
```rust
#[pymethods]
impl TextRenderer {
    #[new]
    fn new(backend: Option<String>) -> PyResult<Self> {
        let backend_name = backend.as_deref().unwrap_or("auto");
        let backend: Box<dyn Backend> = match backend_name {
            #[cfg(all(target_os = "macos", feature = "mac"))]
            "coretext" => Box::new(CoreTextBackend::new()),

            #[cfg(all(target_os = "windows", feature = "windows"))]
            "directwrite" => Box::new(DirectWriteBackend::new()?),

            #[cfg(feature = "icu")]
            "harfbuzz" => Box::new(HarfBuzzBackend::new()),

            #[cfg(feature = "orge")]
            "orge" => Box::new(OrgeBackend::new()),

            "auto" => Self::auto_backend()?,

            // Platform-specific error messages
            #[cfg(not(target_os = "windows"))]
            "directwrite" => {
                return Err(PyRuntimeError::new_err(
                    "DirectWrite backend is only available on Windows"
                ))
            }

            #[cfg(not(target_os = "macos"))]
            "coretext" => {
                return Err(PyRuntimeError::new_err(
                    "CoreText backend is only available on macOS"
                ))
            }

            // Feature-disabled error messages
            #[cfg(not(feature = "icu"))]
            "harfbuzz" => {
                return Err(PyRuntimeError::new_err(
                    "HarfBuzz backend is not available in this build. \
                     Rebuild with: maturin develop --features icu"
                ))
            }

            #[cfg(not(feature = "orge"))]
            "orge" => {
                return Err(PyRuntimeError::new_err(
                    "Orge backend is not available in this build. \
                     Rebuild with: maturin develop --features orge"
                ))
            }

            _ => {
                let available = Self::list_available_backends();
                return Err(PyValueError::new_err(format!(
                    "Unknown backend: '{}'. Available backends: {}",
                    backend_name,
                    available.join(", ")
                )))
            }
        };

        Ok(Self { backend })
    }

    /// List all backends available in this build
    #[staticmethod]
    fn list_available_backends() -> Vec<&'static str> {
        let mut backends = Vec::new();

        #[cfg(all(target_os = "macos", feature = "mac"))]
        backends.push("coretext");

        #[cfg(all(target_os = "windows", feature = "windows"))]
        backends.push("directwrite");

        #[cfg(feature = "icu")]
        backends.push("harfbuzz");

        #[cfg(feature = "orge")]
        backends.push("orge");

        backends
    }
}
```

**Usage:**
```python
import typf

# Check available backends
print(typf.TextRenderer.list_available_backends())
# Output on macOS with mac+icu features: ['coretext', 'harfbuzz']

# Better error messages
try:
    renderer = typf.TextRenderer(backend="directwrite")
except RuntimeError as e:
    print(e)  # "DirectWrite backend is only available on Windows"
```

---

### Fix 3: Complete Orge Backend Implementation (High Priority)

**Phase 1 - Implement Backend Trait:**

Create a segmenter for Orge (can delegate to ICU or simple whitespace splitting):

```rust
// In backends/typf-orge/src/lib.rs

use typf_core::traits::Backend as TypfCoreBackend;
use typf_core::{SegmentOptions, TextRun, RenderOutput};

impl TypfCoreBackend for OrgeBackend {
    fn segment(&self, text: &str, _options: &SegmentOptions) -> TypfResult<Vec<TextRun>> {
        // Simple whitespace segmentation for now
        // TODO: Integrate with ICU segmenter or create OrgeSegmenter
        if text.is_empty() {
            return Ok(Vec::new());
        }

        Ok(vec![TextRun {
            text: text.to_string(),
            start: 0,
            end: text.len(),
            direction: Direction::LeftToRight,
            language: String::new(),
            script: String::new(),
        }])
    }

    fn shape(&self, run: &TextRun, font: &Font) -> TypfResult<ShapingResult> {
        // Orge is a rasterizer, not a shaper
        // Delegate to a real shaper (HarfBuzz) or implement basic shaping
        // For now, return minimal shaping result
        self.shape_text(&run.text, font)
            .map_err(|e| TypfError::shaping(e.to_string()))
    }

    fn render(&self, shaped: &ShapingResult, options: &RenderOptions) -> TypfResult<RenderOutput> {
        // TODO: Implement full text rendering
        // For now, render each glyph individually and composite
        let font = shaped.font.as_ref()
            .ok_or_else(|| TypfError::render("No font in shaping result"))?;

        // This is a placeholder - real implementation needed
        Err(TypfError::render("Orge text rendering not yet implemented"))
    }

    fn clear_cache(&self) {
        // Clear caches
        self.font_data_cache.write().clear();
        self.ttf_cache.write().clear();
    }
}
```

**Phase 2 - Implement Glyph Rendering:**

Connect `render_glyph()` to the existing `GlyphRasterizer`:

```rust
impl DynBackend for OrgeBackend {
    fn render_glyph(&self, font: &Font, glyph_id: u32, options: RenderOptions) -> Option<Bitmap> {
        let ttf_face = self.get_or_create_ttf_face(font).ok()?;
        let font_ref = &ttf_face.font_ref;

        // Get glyph outline
        let glyph = font_ref.outline_glyphs().get(GlyphId::new(glyph_id as u16))?;

        // Calculate pixel size from point size
        let scale = font.size / ttf_face.units_per_em as f32;

        // Use GlyphRasterizer to render
        let mut rasterizer = GlyphRasterizer::new();
        // TODO: Draw glyph path to rasterizer using glyph.path()

        // Convert Image to Bitmap
        let image = rasterizer.render()?;
        Some(Self::image_to_bitmap_rgba(image))
    }
}
```

**Phase 3 - Add to pyproject.toml:**
```toml
[tool.maturin]
features = ["python", "icu", "orge"]  # Add orge to defaults
```

---

## Testing Plan

### Test 1: Feature Detection
```bash
# Clean build
cd /Users/adam/Developer/vcs/github.fontlaborg/typf
rm -rf target/ python/target/ .venv/

# Create fresh venv
uv venv --python 3.12
source .venv/bin/activate

# Build with explicit features
cd python
maturin develop --release --features "python,icu,mac"

# Verify features were applied
cargo rustc -- --print cfg | grep feature
# Expected: feature="icu", feature="mac", feature="python"

# Test backend availability
python -c "
import typf
print('Available:', typf.TextRenderer.list_available_backends())
print('Auto:', typf.TextRenderer())
print('CoreText:', typf.TextRenderer(backend='coretext'))
"
```

### Test 2: Error Messages
```python
import typf

# Test platform-specific error
try:
    typf.TextRenderer(backend="directwrite")
except RuntimeError as e:
    assert "only available on Windows" in str(e)

# Test feature-disabled error (if orge not built)
try:
    typf.TextRenderer(backend="orge")
except RuntimeError as e:
    assert "not available in this build" in str(e)

# Test unknown backend
try:
    typf.TextRenderer(backend="fakebackend")
except ValueError as e:
    assert "Available backends:" in str(e)
```

### Test 3: Orge Integration
```rust
// In backends/typf-orge/tests/integration.rs

#[test]
fn test_orge_implements_backend_trait() {
    use typf_core::traits::Backend;
    let backend = OrgeBackend::new();

    // Test segment
    let segments = backend.segment("Hello world", &Default::default()).unwrap();
    assert!(!segments.is_empty());

    // Test shape (once implemented)
    // Test render (once implemented)
}
```

---

## Recommendations

### Immediate Actions (v1.0.9)
1. ‚úÖ **Document the issue** (this file)
2. üîß **Fix CoreText feature enablement** - Use Option A (platform-conditional features)
3. üîß **Improve error messages** - Implement Fix 2
4. üìù **Update CLAUDE.md** - Document correct build process

### Short-term (v1.1.0)
1. üîß **Complete Orge Backend trait implementation** - Implement Fix 3 Phase 1-2
2. ‚úÖ **Add integration tests** - Test all backends on all platforms
3. üìù **Update documentation** - Add backend comparison guide

### Long-term Architectural Decisions
1. **Unify trait system** - Decide if we need both `Backend` and `DynBackend`
2. **Backend discovery** - Add compile-time backend enumeration
3. **CI/CD** - Add multi-platform wheel builds with correct features

---

## Related Issues
- Issue 103: Backend refactoring compilation errors (resolved)
- Issue 104: Python bindings enhancement (partial)
- Issue 200: Performance speedups for Orge backend

## Files Affected
- `python/src/lib.rs` - Backend selection logic
- `pyproject.toml` - Feature configuration
- `backends/typf-orge/src/lib.rs` - Missing trait implementations
- `python/Cargo.toml` - Feature definitions
- `CLAUDE.md` - Build documentation

---

**Made by FontLab https://www.fontlab.com/**
